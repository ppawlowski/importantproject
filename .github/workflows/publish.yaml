name: Debug
on:
  workflow_run:
    workflows: 
      - 'Tests'
    types: 
      - completed

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: print context
        env:
          GITHUB_CONTEXT:  ${{ toJson(github) }} 
          VARS_CONTEXT:  ${{ toJson(vars) }} 
        run: |
          echo "GITHUB_CONTEXT is $GITHUB_CONTEXT"
          echo "VARS_CONTEXT is $VARS_CONTEXT"

  check-upstream-jobs:
    runs-on: ubuntu-latest
    steps:
      - name: Check upstream job statuses
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const { data } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            
            // List of job names to check
            const jobsToCheck = [
              'Backend tests', 
              'UI tests'
            ];
            
            // Find the jobs we want to check
            const relevantJobs = data.jobs.filter(job => jobsToCheck.includes(job.name));
            
            // Check if any job failed
            const failedJobs = relevantJobs.filter(job => job.conclusion === 'failure');
            
            if (failedJobs.length > 0) {
              console.log('The following jobs failed:');
              failedJobs.forEach(job => {
                console.log(`- ${job.name}`);
              });
              process.exit(1);
            } else {
              console.log('All specified jobs passed or were skipped');
              process.exit(0);
            }
  publish:
    runs-on: ubuntu-latest
    needs: [check-upstream-jobs]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Publish
        run: |
          echo "Publishing"
          sleep 10
